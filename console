#!/usr/bin/bash

#GLOBAL VAR

uid=$(id -u)
userna=$(id -nu $uid)
userhome="/home/taglio"
proghome="$userhome/Sources/Git/OpenBSD"

if [[ $uid -ne 1000 ]]; then
	echo -e $0 "you've got to run $0 as UID=1000 \n"
	exit 1
fi

if [[ $# -eq 0 ]]; then
	echo -e $0 "have to be used with the following options \
			\n-I  -> local domain name [x]\
			\n-N  -> newhost [o]\
			\n-G  -> git pull [o]\
			\n"
	
	exit 1
fi

localdomainname=$2


case $3 in
	"-G")
		for vpnc_host in $(dig openbsd.$localdomainname TXT +short | sed "s/\"//g" | tr \; '\n' | sed '$d'); do
			echo -e "Connecting to $vpnc_host"
			ssh $vpnc_host.$localdomainname git -C "$proghome" pull
		done	
	;;
	"-N")
		for vpnc_host in $(dig openbsd.$localdomainname TXT +short | sed "s/\"//g" | tr \; '\n' | sed '$d'); do
			echo -e "Connecting to $vpnc_host"
			ssh -t $vpnc_host.$localdomainname doas sh "/home/taglio/Sources/Git/OpenBSD/setup_node" -U newhost
		done	
	;;
	*)
	;;
esac
