#!/bin/ksh

#	$Telecomlobby: setup_node,v 0.1 11/3/2021 21:01:04 taglio$
#
#unbound: https://blog.c6h12o6.org/post/unbound-dnssec-dns-over-tls/


set -o errexit
set -o nounset

PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/root/Bin

function error_exit {
    echo "${app}: ${1:-"Unknown Error"}" 1>&2
    exit 1
}

app=$(basename $0)
INSTALL=/usr/bin/install
RCCTL=/usr/sbin/rcctl
USERADD=/usr/sbin/useradd
PKG_ADD=/usr/sbin/pkg_add
PFCTL=/sbin/pfctl
SH=/bin/ksh

function pkg {
	phase=$1

	case $phase in
		"shell")
			pkg_add colorls nano wget fping iperf uptimed oidentd;;
	esac
}

function conf {
	phase=$1
	if [[ -z "$2" ]]; then
		subphase = $2
	fi
	case $phase in
		"basic")
			echo "dot files"
			for file in src/home/taglio/.*; do
				$INSTALL -o taglio -g wheel -m 0750 -b $file /home/taglio/
			done
			for file in src/root/.*; do
				$INSTALL -o root -g root -m 0750 -b $file /root/
			done
			echo "dhclient, resolv.conf.tail and doas.conf"
			$INSTALL -o root -g wheel -m 0644 -b src/etc/{dhclient.conf,resolv.conf.tail,doas.conf} /etc/
			$INSTALL -o root -g wheel -m 0640 -b src/etc/hostname.vio0 /etc/
			$SH /etc/netstart vio0
			echo "vether"
			$INSTALL -o root -g wheel -m 0644 -b src/etc/hostname.vether0 /etc/
			$SH /etc/netstart vether0 
			echo "configuring iperf uptimed and oidentd"
			$RCCTL enable uptimed
			$RCCTL start uptimed
			$INSTALL -o root -g wheel -m 0640 -b src/etc/rc.local /etc/
			$SH /etc/rc.local ;;	
		"users")
			echo "vmail, dsync, _iperfd, wwwuser"
			$USERADD -m -u 2000 -g =uid -c "Virtual Mail" -d /var/vmail -s /sbin/nologin vmail
			$USERADD -m -u 2001 -g =uid -c "Dsync Replication" -d /home/dsync -s /bin/ksh dsync
			$USERADD -m -u 2002 -g =uid -c "Iperfd Daemon" -d /nonexistent -s /sbin/nologin _iperfd
			$USERADD -m -u 2003 -g =uid -c "WWW Ftpd user" -d /var/www/htdocs -s /root/Bin/fake_shell.sh wwwftp
			for file in src/home/taglio/Bin/*; do
				$INSTALL -o taglio -g wheel -m 0750 -b $file /home/taglio/Bin/
			done
			su taglio -
			ssh-keygen -t ed25519 -N "" -f /home/taglio/.ssh/id_ed25519
			exit ;;
		"scripts")
			for file in src/root/Bin/*.sh; do
				$INSTALL -o root -g wheel -m 0700 -b $file /root/Bin/
			done ;;
		"unbound")
			$RCCTL enable unbound
			case $subphase in 
				"local")
					unbound-anchor -a /var/unbound/db/root.key
					wget https://www.internic.net/domain/named.root -O /var/unbound/db/root.hints
					$INSTALL -o _unbound -g _unbound -m 0750 -b src/var/unbound/db/ca-certificates.crt /var/unbound/db/
					chown _unbound:_unbound /var/unbound/db/*
					$INSTALL -o _unbound -g _unbound -m 0750 -b src/var/unbound/etc/unbound-local.conf /var/unbound/etc/unbound.conf
					$INSTALL -o _unbound -g _unbound -m 0750 -b src/var/unbound/etc/remote-control.conf /var/unbound/etc/
					$INSTALL -o _unbound -g _unbound -m 0750 -b src/var/unbound/etc/forward-zone.conf /var/unbound/etc/ ;;
				"network")
					$INSTALL -o _unbound -g _unbound -m 0750 -b src/var/unbound/etc/unbound.conf /var/unbound/etc/unbound.conf
					$INSTALL -o _unbound -g _unbound -m 0750 -b src/var/unbound/etc/stub-zone.conf /var/unbound/etc/stub-zone.conf
					$RCCTL restart unbound ||  error_exit "$LINENO: ERROR: UNBOUND failed." ;;
			esac
			;;
		"ipsec")
			iked_ca_reset.sh
			$INSTALL -o root -g wheel -m 0640 -b src/etc/iked/ca/ca.crt /etc/iked/ca/
			ssl_pk12_cert_pub_priv_extract.sh uk.telecomlobby.com.p12
			$RCCTL enable iked
			$RCCTL set iked flags "-vv"
			$INSTALL -o root -g wheel -m 0640 -b src/etc/iked.conf /etc/
			$RCCTL start iked ;;
		"gre")
			for file in src/etc/hostname.gre? ; do
				$INSTALL -o root -g wheel -m 0700 -b $file /etc/
				$SH /etc/netstart $(echo $file | awk -F. '{print $2}')
			done ;;
		"pf")
			for file in src/etc/pf.* ; do
				$INSTALL -o root -g wheel -m 0700 -b $file /etc/
			done 
			$PFCTL -nf /etc/pf.conf ||  error_exit "$LINENO: ERROR: PF failed."
			$PFCTL -f /etc/pf.conf ;;
		"ospf")
			$RCCTL enable ospfd
			$INSTALL -o root -g wheel -m 0600 -b src/etc/ospfd.conf /etc/
			$RCCTL start ospfd ||  error_exit "$LINENO: ERROR: OSPFD failed." ;;
		"ntpd")
			$INSTALL -o root -g wheel -m 0644 -b src/etc/ntpd.conf /etc/
			$RCCTL restart ntpd  ||  error_exit "$LINENO: ERROR: NTPD failed." ;;		
	esac
}

echo "changing installurl"
ctrl=
while [ -z $ctrl ]
do
	echo -n 'Go ahead type 1 '
	read ctrl
	if [[ "$ctrl" -eq 1 ]]; then
		$INSTALL -o root -g wheel -m 0644 -b src/etc/installurl /etc/
	else
		error_exit "$LINENO: EXIT FROM USER." 
	fi
    
done		
echo "adding basic shell packages"
ctrl=
while [ -z $ctrl ]
do
	echo -n 'Go ahead type 1 '
	read ctrl
	if [[ "$ctrl" -eq 1 ]]; then
		pkg "shell"
	else
		error_exit "$LINENO: EXIT FROM USER." 
	fi
    
done	
echo "configuring users"
ctrl=
while [ -z $ctrl ]
do
	echo -n 'Go ahead type 1 '
	read ctrl
	if [[ "$ctrl" -eq 1 ]]; then
		if [ ! -d /root/Bin ]; then 
			mkdir /root/Bin
			echo "ok"
		fi
		chmod 700 /root/Bin
		if [ ! -d /home/taglio/Bin ]; then 
			mkdir /home/taglio/Bin 
		fi
		chown taglio:wheel /home/taglio/Bin
		conf "users"
		conf "scripts"
	else
		error_exit "$LINENO: EXIT FROM USER." 
	fi
    
done
	
hostname=
while [ -z $hostname ]
do
	echo -n 'Type the hostname '
	read hostname
	echo $hostname > conf/hostname
	sed -i "s/$hostname/\/HOSTNAME\//g" {src/etc/*,src/var/unbound/etc/*}
done
routerid=
while [ -z $routerid ]
do
	echo -n 'Type the routerid '
	read routerid
	echo $routerid > conf/routerid
	sed -i "s/$routerid/\/ROUTERID\//g" {src/etc/*,src/var/unbound/etc/*}
done
publichost=
while [ -z $publichost ]
do
	echo -n 'Type the publichost '
	read publichost
	echo $publichost > conf/publichost
	sed -i "s/$publichost/\/PUBLICHOST\//g" {src/etc/*,src/var/unbound/etc/*}
done
echo "configuring basic"
ctrl=
while [ -z $ctrl ]
do
	echo -n 'Go ahead type 1 '
	read ctrl
	if [[ "$ctrl" -eq 1 ]]; then
		conf "basic" 
	else
		error_exit "$LINENO: EXIT FROM USER." 
	fi
    
done
echo "configuring unbound"
ctrl=
while [ -z $ctrl ]
do
	echo -n 'Go ahead type 1 '
	read ctrl
	if [[ "$ctrl" -eq 1 ]]; then
		conf "unbound" "local"
	else
		error_exit "$LINENO: EXIT FROM USER." 
	fi
    
done

