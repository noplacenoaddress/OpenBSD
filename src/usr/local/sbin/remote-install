#!/bin/ksh

ipconnected=$(cat /var/log/authlog | grep Accepted | tail -n 1| awk '{print $11}')
hostconnected=$(dig -x $ipconnected +short @8.8.8.8)
egressinterface=$(ifconfig egress | cut -d  : -f1 | head -n1)
publicip=$(ifconfig $egressinterface | grep inet |grep -v inet6 | cut -d ' ' -f2)
publicnetmask=$(ifconfig $egressinterface | grep inet | grep -v inet6 | awk '{print $4}')
publicbcast=$(ifconfig $egressinterface | grep inet | grep -v inet6 | awk '{print $6}')
publichost=$(dig -x $publicip +short @8.8.8.8 | sed 's/.$//')
domainname=$(print $publichost | sed 's/^[^.]*.//')
defaultv4router=$(route -n show | awk '/default/{print $2}' | head -n 1)
macdefaultv4router=$(arp -an | grep $defaultv4router |  awk '{print $2}')
tmpdir=$(mktemp -d)

cd $tmpdir
wget "http://$hostconnected/$publichost.tar" 
wget "http://$hostconnected/$publichost.sha256" 
logger "$0: update downloaded from $hostconnected"
tarsha256=$(sha256 "$publichost.tar" | awk '{print $4}')
if [ "$tarsha256" == $(cat "$publichost.sha256") ]; then
	tar xvf "$publichost.tar"
	install -o root -g wheel -m 0640 hostname.gre? /etc/
	install -o root -g whell -m 0640 iked.conf.* /etc/
	vpnc_host=$(ls iked.conf.* | sed 's/iked.conf.//')
	echo include \"/etc/iked.conf.$vpnc_host\" >> /etc/iked.conf
	rcctl restart iked
	greinterface=$(ls hostname.gre? | sed 's/hostname.//')
	sh /etc/netstart $greinterface
	sed -i '$d' /etc/ospfd.conf
	cat ospfd.conf >> /etc/ospfd.conf
	echo "}" >> /etc/ospfd.conf
	rcctl restart ospfd
	
else
	logger "$0: sha256 failed from $publichost.tar"
fi


